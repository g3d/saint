<% remote_node = @relation.remote_node
   tree = remote_node && remote_node.saint.is_tree?
   local_item_children = tree && @local_item ?
           @local_item.send(tree[:has_n].children).inject({}) { |children, child| children.update(child[@relation.local_pkey] => child) } :
           {}
-%>
<table class="table">
  <thead>
  <tr>
    <% if level == 0 -%>
        <th style="width: 5%;">
          #
        </th>
        <th style="width: 5%;"></th>
    <% end -%>
    <% if remote_node -%>
        <th>
          <%== remote_node.saint.h -%>
        </th>
    <% else -%>
        <% @remote_columns.each do |column| -%>
            <th style="<%= 'width: ' + (90 / @remote_columns.size).ceil.to_s + '%;' %>">
              <%= column.label %>
            </th>
        <% end -%>
    <% end -%>
  </tr>
  </thead>
  <% items_counter = @pager.items + 1
     items.each do |remote_item|
         remote_item_id = remote_item[@relation.remote_pkey]
         children = tree ? remote_item.send(tree[:has_n].children) : []
         self_color = color || Saint.tree_colors.sample
         bg_color = color || (self_color if children.size > 0) -%>
      <tr class="saint-selectable" style="<%= "background-color: ##{bg_color}" if bg_color %>">
        <% if level == 0 -%>

            <td style="text-align: center;">
              <a class="btn" target="_blank"
                 href="<%= remote_node ? remote_node.http.route(:edit, remote_item_id) : 'javascript:void(0);' %>">
                <%= (items_counter -= 1) - @pager.page_number * @pager.items_per_page %>
              </a>
            </td>

            <% unless @relation.readonly
                   active = @attached_keys_or_remote_item.respond_to?(@relation.remote_pkey) &&
                           @attached_keys_or_remote_item.send(@relation.remote_pkey) == remote_item_id
                   disabled = @relation.is_tree? &&
                           (local_item_children[remote_item_id] || remote_item_id == @local_id) -%>
                <td style="text-align: center;">
                  <% if level == 0 -%>
                      <input type="radio"
                             name="saint-belongs_to_selector-<%= @relation.id %>"
                             <%= 'checked="true"' if active -%>
                             <%= 'disabled="true"' if disabled -%>
                             <% if @local_id > 0 -%>
                             onclick="if(confirm('Please confirm Select action')){ <%= "update_relation_%s('%s', 'saint-belongs_to_selector-%s');" % [@relation.id, remote_item_id, @relation.id] %> } else { $(this).attr('checked', false) }"
                             <% else -%>
                             onclick="Saint.update_value('<%= @relation.id %>-element', '<%= remote_item_id %>');"
                             <% end -%>
                             />
                  <% end -%>
                </td>
            <% end -%>
        <% end -%>

        <% if remote_node -%>
            <td>
              <a href="<%= remote_node.http.route(:edit, remote_item_id) %>" target="_blank">
                <%== remote_node.saint.h remote_item, label: nil -%>
              </a>
            </td>
        <% else -%>
            <% @remote_columns.each do |column| -%>
                <td>
                  <%= column.summary_value remote_item, self %>
                </td>
            <% end -%>
        <% end -%>

      </tr>

      <% if children.size > 0
             children_container_id = '%s%s%s%s_children_container' % [@relation.id, @attached, level, remote_item_id] -%>
          <tr>
            <td></td>
            <td style="text-align: right; vertical-align: top;">
              <% if level == 0 -%>
                  <div id="<%= children_container_id %>-status" style="cursor: pointer;" class="saint-text_note"
                       onclick="Saint.Utils.toggleChildrenContainer('<%= children_container_id %>');">
                    children +
                  </div>
              <% end -%>
            </td>
            <td colspan="<%= @relation.remote_node ? 0 : @remote_columns.size %>">
              <div id="<%= children_container_id %>" style="<%= 'display: none;' if level == 0 %>">
                <%= saint_view.render_partial('list/assoc/belongs_to-partial', items: children, level: level + 1, color: self_color) %>
              </div>
            </td>
          </tr>
      <% end -%>

  <% end %>

</table>
