<% remote_node = @relation.remote_node -%>

<% if http.xhr? -%>
    <script type="text/javascript" src="<%= Saint::FileServer["ui.js"] %>"></script>
<% end -%>

<% if (xhr = http.params['xhr']).nil? -%>

    <script type="text/javascript">
        <%= "function update_relation_#{@relation.id}(val, element_id) {" %>
        Saint.valid_GET('<%= @relation.local_node.http.route(:save, @local_id) << '?' << @relation.local_key.to_s %>=' + val, function(response) {
                    Saint.update_value('<%= @relation.id %>-element', response.status);
                    Saint.update_container('saint-crud-header', '<%= http.route :head, @local_id %>');
                    Saint.update_container('<%= @relation.id %>0', '<%= @relation.local_node.http.route(:assoc__any__remote_items, @relation.id , @local_id, 0) %>');
                    Saint.alert(response.message);
                }, function(response) {
                    $('#' + element_id).attr('checked', false);
                    Saint.alert(response.message);
                }
        );
        <%= "}" %>
    </script>

    <% if (remote_item = @attached_keys_or_remote_item).respond_to?(@relation.remote_pkey) -%>
        <div>
          <p class="alert alert-info">
            Belongs to:
            <a href="<%= @relation.remote_node ? @relation.remote_node.http.route(:edit, remote_item[saint.pkey]) : 'javascript:void(0);' %>" target="_blank">
              <%== @relation.remote_node ?
                           @relation.remote_node.saint.h(remote_item) :
                           @remote_columns.map { |c| val = c.summary_value(remote_item, self).to_s; val.size > 0 ? val : nil }.compact.join(', ')
              %>
            </a>
          </p>

          <p>
            <input type="button" value="detach" class="btn btn-info"
                   <% if @local_id > 0 -%>
                   onclick="if(confirm('Please confirm Detach action')){ <%= "update_relation_#{@relation.id}('#{SaintConst::NULL_VALUE}');" %> }"
                   <% else -%>
                   onclick="if(confirm('Please confirm Detach action')){ Saint.update_value('<%= @relation.id %>-element', '<%= SaintConst::NULL_VALUE %>'); }"
                   <% end -%>
                   />
            if current item does not belong to any <%= @relation.label %>
          </p>
        </div>
    <% end -%>
<% end -%>

<% if xhr.nil? && remote_node && filters = remote_node.saint.filters(Hash.new, :html)
       filters_route = http.route(:assoc__any__remote_items, @relation.id, @local_id, "/") -%>
    <form action="<%= filters_route %>0" id="saint_assoc_filters-<%= @relation.id %>">
      <input type="hidden" name="xhr" value="true"/>
      <%= filters -%>
      <div class="inline topped">
        <div class="saint-filter_label">&nbsp;</div>
        <div class="btn-group">
          <a class="btn void-link"
             onclick="Saint.update_container('<%= @relation.id + @attached.to_s %>-items', {form: 'saint_assoc_filters-<%= @relation.id %>'});">
            <i class="icon-search"></i>
            Search</a>
          <a class="btn void-link"
             onclick="Saint.update_container('<%= @relation.id + @attached.to_s %>-items', '<%= filters_route %>0?xhr=true');">
            Reset</a>
        </div>
      </div>
    </form>
<% end -%>

<div id="<%= @relation.id + @attached.to_s %>-items">
  <% if @remote_items.size > 0 -%>
      <%= @pager.html %>
      <%= saint_view.render_partial('list/assoc/belongs_to-partial', items: @remote_items, level: 0, color: nil) %>
  <% end %>
</div>
