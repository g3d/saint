<% remote_node = @relation.remote_node -%>

<script type="text/javascript" src="<%= Saint::FileServer["ui.js"] %>"></script>

<div id="<%= @relation.id %>-belongs_to-update-errors"></div>
<% if (xhr = http.params['xhr']).nil? -%>

    <script type="text/javascript">
        <%= "function update_relation_#{@relation.id}(val) {" %>
        Saint.valid_get(
                '<%= @relation.local_node.http.route(:save, @local_id) + "?" + @relation.local_key.to_s %>=' + val,
                function() {
                    Saint.update_value('<%= @relation.id %>-element', val);
                    Saint.update_container(
                            '<%= @relation.id %>0',
                            '<%= @relation.local_node.http.route(:assoc__any__remote_items, @relation.id , @local_id, 0) %>'
                    )
                },
                '<%= @relation.id %>-belongs_to-update-errors'
        );
        <%= "}" %>
    </script>

    <% if (remote_item = @attached_keys_or_remote_item).respond_to?(@relation.remote_pkey) -%>
        <div style="margin-bottom: 10px;">
          <table style="width: 100%;">
            <tr>
              <td class="ui-widget-header saint-header">
                Belongs to:
                <a href="<%= @relation.remote_node ? @relation.remote_node.http.route(:edit, remote_item[saint.pkey]) : 'javascript:void(0);' %>" target="_blank">
                  <%= @relation.remote_node ?
                              @relation.remote_node.saint.h(remote_item) :
                              @remote_columns.map { |c| val = c.summary_value(remote_item).to_s; val.size > 0 ? val : nil }.compact.join(', ')
                  %>
                </a>
              </td>
            </tr>
            <tr>
              <td>
                <input type="button" value="detach" class="saint-button"
                       <% if @local_id > 0 -%>
                       onclick="if(confirm('Please confirm Detach action')){ <%= "update_relation_#{@relation.id}('#{::Saint::RV_NULL_VALUE}');" %> }"
                       <% else -%>
                       onclick="if(confirm('Please confirm Detach action')){ Saint.update_value('<%= @relation.id %>-element', '<%= ::Saint::RV_NULL_VALUE %>'); }"
                       <% end -%>
                       />
                if current item does not belong to any <%= @relation.label %>
              </td>
            </tr>
          </table>
        </div>
    <% else -%>
        <script type="text/javascript">
            $(function() {
                Saint.update_value('<%= @relation.id %>-element', '<%= ::Saint::RV_NULL_VALUE %>');
            });
        </script>
    <% end -%>
<% end -%>

<% if xhr.nil? && remote_node && filters = remote_node.saint.filters(http.params, :html)
       filters_route = http.route(:assoc__any__remote_items, @relation.id, @local_id, "/") -%>
    <form action="<%= filters_route %>0" id="saint_assoc_filters-<%= @relation.id %>">
      <input type="hidden" name="xhr" value="true"/>
      <%= filters -%>
      <div style="display: inline-block;">
        <div class="saint-filter_label">&nbsp;</div>
        <input type="button" value="search" class="saint-button"
               onclick="Saint.submit_form('saint_assoc_filters-<%= @relation.id %>', '<%= @relation.id + @attached.to_s %>-items');"
        />
        <input value="reset" type="button" class="saint-button"
               onclick="Saint.update_container('<%= @relation.id + @attached.to_s %>-items', '<%= filters_route %>0?xhr=true');"
        />
      </div>
    </form>
<% end -%>

<div id="<%= @relation.id + @attached.to_s %>-items">
  <% if @remote_items.size > 0 -%>
      <%= @pager.html %>
      <%= saint_view.render_partial('list/assoc/belongs_to-partial', items: @remote_items, level: 0, color: nil) %>
  <% end %>
</div>

